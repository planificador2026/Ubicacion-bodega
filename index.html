<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ubicación / Stock por Bodega</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --muted:#9fb0d0;
      --text:#eaf0ff;
      --line:rgba(255,255,255,.10);
      --focus:rgba(120,170,255,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(88,140,255,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(0,255,209,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding: 18px;
    }
    .wrap{max-width: 980px; margin: 0 auto;}
    .top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }
    h1{font-size: 20px; margin:0 0 6px 0; letter-spacing:.2px}
    .subtitle{color:var(--muted); font-size:13px; line-height:1.35}
    .pill{
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
      background: rgba(255,255,255,.03);
      white-space: nowrap;
    }
    .search{
      width: 100%;
      display:flex;
      gap:10px;
      margin: 12px 0 12px 0;
      flex-wrap:wrap;
    }
    input{
      flex: 1 1 420px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline: none;
      font-size: 15px;
    }
    input:focus{ box-shadow: 0 0 0 4px var(--focus); }
    select{
      flex: 0 0 220px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
      font-size: 14px;
    }
    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      overflow: hidden;
    }
    table{
      width:100%;
      border-collapse: collapse;
    }
    thead th{
      text-align:left;
      font-size:12px;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      font-size: 14px;
      vertical-align: top;
    }
    tbody tr:hover{ background: rgba(255,255,255,.04); }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px;}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .footer{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .hint{opacity:.95}
    .badge{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Buscar ubicación / stock por bodega</h1>
        <div class="subtitle">Escribe para filtrar por <span class="badge">código</span>, <span class="badge">descripción</span> o <span class="badge">bodega</span>. (Basado en tu CSV)</div>
      </div>
      <div class="pill" id="meta">Cargando…</div>
    </div>

    <div class="search">
      <input id="q" placeholder="Ej: 1051DC080080, ATB, DES, etc." autocomplete="off" />
      <select id="bodega">
        <option value="">Todas las bodegas</option>
      </select>
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th style="width:160px">Código</th>
            <th>Producto</th>
            <th style="width:110px">Familia</th>
            <th style="width:90px">Bodega</th>
            <th class="right" style="width:120px">Stock</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="hint">Tip: puedes buscar por parte del nombre del cliente o por código de bodega (ej: <b>DES</b>).</div>
      <div id="count"></div>
    </div>
  </div>

<script>
  // IMPORTANTE: el nombre del archivo tiene espacios; en web debe ir URL-encoded
  const CSV_FILE = "STOCK%20POR%20BODEGA.csv"; // si renombras el archivo, cambia esto

  const $q = document.getElementById('q');
  const $rows = document.getElementById('rows');
  const $meta = document.getElementById('meta');
  const $count = document.getElementById('count');
  const $bodega = document.getElementById('bodega');

  let data = [];

  function normalize(s){
    return (s ?? "").toString().trim();
  }

  function parseStock(raw){
    const s = normalize(raw).replace(/\s+/g,'');
    if(!s) return null;
    // Heurística: si tiene coma, la coma es decimal y el punto miles.
    if (s.includes(',')){
      const cleaned = s.replace(/\./g,'').replace(',', '.');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }
    // Si tiene puntos, asume miles (1.900 -> 1900)
    if (s.includes('.')){
      const cleaned = s.replace(/\./g,'');
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : null;
    }
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function fmtNumber(n){
    if (n === null || n === undefined) return "";
    try{
      return new Intl.NumberFormat('es-CL').format(n);
    }catch(e){
      return String(n);
    }
  }

  function parseCSV(text){
    // CSV separado por ; (tu archivo)
    const lines = text.replace(/\r/g,'').split('\n').filter(l => l.trim().length);
    const headers = lines[0].split(';').map(h => h.trim());
    return lines.slice(1).map(line => {
      const cols = line.split(';');
      const obj = {};
      headers.forEach((h, i) => obj[h] = (cols[i] ?? "").trim());
      return obj;
    });
  }

  function buildBodegaFilter(rows){
    const bodegas = Array.from(new Set(rows.map(r => normalize(r.KOBO)).filter(Boolean))).sort();
    bodegas.forEach(b => {
      const opt = document.createElement('option');
      opt.value = b;
      opt.textContent = b;
      $bodega.appendChild(opt);
    });
  }

  function applyFilter(){
    const term = normalize($q.value).toLowerCase();
    const bodegaSel = normalize($bodega.value);

    const filtered = data.filter(r => {
      if (bodegaSel && normalize(r.KOBO) !== bodegaSel) return false;
      if (!term) return true;
      const hay = [
        r.KOPR, r.NOKOPR, r.FMPR, r.KOBO, r.STFI1
      ].map(v => normalize(v).toLowerCase()).join(' ');
      return hay.includes(term);
    });

    render(filtered);
  }

  function render(rows){
    $rows.innerHTML = rows.map(r => {
      const code = normalize(r.KOPR);
      const name = normalize(r.NOKOPR);
      const fam = normalize(r.FMPR);
      const bod = normalize(r.KOBO);
      const stockN = parseStock(r.STFI1);
      const stock = stockN === null ? normalize(r.STFI1) : fmtNumber(stockN);

      return `
        <tr>
          <td class="mono">${escapeHtml(code)}</td>
          <td>${escapeHtml(name)}</td>
          <td class="mono muted">${escapeHtml(fam)}</td>
          <td class="mono">${escapeHtml(bod)}</td>
          <td class="right mono">${escapeHtml(stock)}</td>
        </tr>
      `;
    }).join('');

    $count.textContent = `${rows.length.toLocaleString('es-CL')} resultado(s)`;
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  async function init(){
    const res = await fetch(CSV_FILE, { cache: "no-store" });
    const txt = await res.text();
    data = parseCSV(txt);

    buildBodegaFilter(data);
    $meta.textContent = `Registros: ${data.length.toLocaleString('es-CL')}`;
    render(data);

    $q.addEventListener('input', applyFilter);
    $bodega.addEventListener('change', applyFilter);
  }

  init().catch(err => {
    console.error(err);
    $meta.textContent = "No se pudo cargar el CSV";
    $rows.innerHTML = `<tr><td colspan="5" class="muted">Error cargando el archivo. Verifica que <b>${CSV_FILE}</b> esté en la misma carpeta que este index.html.</td></tr>`;
  });
</script>
</body>
</html>
